name: Deploy Next.js to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js (for local actions like linting or pre-build checks)
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "~/nextjs-app"

      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          # --- IMPORTANT: ADDED TIMEOUT PARAMETERS HERE ---
          timeout: 300 # Increased timeout to 300 minutes (5 hours). Adjust as needed.
          connect_timeout: 60 # Increased connection timeout to 60 seconds. Adjust as needed.
          script: |
            # --- EC2 Setup and Deployment Script ---

            mkdir -p ~/nextjs-app
            cd ~/nextjs-app

            rm -rf .next node_modules

            if ! command -v node &> /dev/null; then
              echo "Node.js not found. Installing Node.js 22.x..."
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get update
              sudo apt-get install -y nodejs
            else
              echo "Node.js already installed."
            fi

            if ! command -v pm2 &> /dev/null; then
              echo "PM2 not found. Installing PM2 globally..."
              sudo npm install -g pm2
            else
              echo "PM2 already installed."
            fi

            echo "Installing project dependencies..."
            npm install # This is where your previous error occurred due to timeout

            echo "Building Next.js application..."
            npm run build

            echo "Stopping and deleting old PM2 process (if any)..."
            pm2 delete next-app || true

            echo "Starting Next.js application with PM2..."
            pm2 start npm --name "next-app" -- start

            echo "Saving PM2 process list..."
            pm2 save --force
